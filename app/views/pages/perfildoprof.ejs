<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/imagens/logo-bblt.png" sizes="any">
    <title>Perfil do Profissional | InovaCare</title>

    <!--Link dos ícones da barra de navegação-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!--link do arquivo css-->
    <link rel="stylesheet" href="/css/perfil.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/barranav.css">
    <link rel="stylesheet" href="/css/perfil-upload.css">
    <link rel="stylesheet" href="/css/perfildoprof.css">
</head>

<body>
    <% if (usuarioLogado) { %>
        <!--barra de navegação - início -->
        <nav class="menu-desktop">

            <!--Espaço para a logo-->
            <section class="menu-logo">
                <a href="/logado-user-pac">
                    <img class="logo logo-desktop" src="/imagens/logo-bblt.png" alt="Logo InovaCare">
                    <img class="logo logo-tablet" src="/imagens/logo-extenso.png" alt="Logo InovaCare">
                    <img class="logo logo-mobile" src="/imagens/logo-borboleta.png" alt="Logo InovaCare">
                </a>
            </section>

            <!--Botão de pesquisa-->
            <ul class="menu-list">
                <li class="dropdown">
                    <a class="sobre" href="#">Sobre</a>
                    <section class="dropdown-content">
                        <a href="#">Quem somos</a>
                        <a href="#">Contato</a>
                        <a href="#">FAQ</a>
                    </section>
                </li>
                <li><a class="agendamento" href="/especialidades">Agendamento</a></li>
                <li><a class="consultas" href="/consultas">Área de Consultas</a></li>
            </ul>


            <ul class="menu-list-direita">
                <li><a href="/perfil" class="icon-perfil" aria-label="Perfil"><i class="bi bi-person-circle"></i></a></li>
                <li class="dropdown">
                    <button class="icon-perfil" aria-label="Menu"><i class="bi bi-three-dots-vertical"></i></button>
                    <section class="dropdown-content">
                        <a href="/sair" class="btn-sair">Sair</a>
                    </section>
                </li>
            </ul>

        </nav>

        <nav class="mobile-menu">
            <section class="menu-logo">
                <a href="/logado-user-pac">
                    <img class="logo logo-desktop" src="/imagens/logo-bblt.png" alt="Logo InovaCare">
                    <img class="logo logo-tablet" src="/imagens/logo-extenso.png" alt="Logo InovaCare">
                    <img class="logo logo-mobile" src="/imagens/logo-borboleta.png" alt="Logo InovaCare">
                </a>
            </section>

            <ul class="menu-actions">
                <li><a href="/perfil" class="icon-perfil" aria-label="Perfil"><i class="bi bi-person-circle"></i></a></li>
                <li class="dropdown">
                    <button class="icon-perfil" aria-label="Menu"><i class="bi bi-three-dots-vertical"></i></button>
                    <ul class="dropdown-content">
                        <li><a href="/sair" class="btn-sair-mobile">Sair</a></li>
                    </ul>
                </li>
                <li><button class="hamburguer" onclick="toggleMenu()" aria-label="Menu"></button></li>
            </ul>

            <!-- Menu suspenso do hambúrguer -->
            <ul id="hamburger-menu" class="hamburger-menu-content">
                <li class="dropdown">
                    <a href="#">Sobre</a>
                    <ul class="dropdown-content">
                        <li><a href="#">Quem somos</a></li>
                        <li><a href="#">Contato</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </li>
                <li><a href="/especialidades">Agendamento</a></li>
                <li><a href="/consultas">Área de Consultas</a></li>
            </ul>
        </nav>

        <script>
            function toggleMenu() {
                const menu = document.getElementById("hamburger-menu");
                menu.style.display = menu.style.display === "block" ? "none" : "block";
            }
        </script>

        <!--barra de navegação - fim ^^^ -->
    <% } else { %>
        <!--barra de navegação - início -->
        <nav class="menu-desktop">

          <!--Espaço para a logo-->
          <section class="menu-logo">
            <a href="/">
              <img class="logo logo-desktop" src="/imagens/logo-bblt.png" alt="Logo InovaCare">
              <img class="logo logo-tablet" src="/imagens/logo-extenso.png" alt="Logo InovaCare">
              <img class="logo logo-mobile" src="/imagens/logo-borboleta.png" alt="Logo InovaCare">
            </a>
          </section>

          <!--Botão de pesquisa-->
          <ul class="menu-list">
            <li class="dropdown">
              <a class="sobre" href="#">Sobre</a>
              <section class="dropdown-content">
                <a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">Quem somos</a>
                <a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">Contato</a>
                <a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">FAQ</a>
              </section>
            </li>
            <li><a class="agendamento" href="/especialidades">Agendamento</a></li>
            <li><a class="consultas" href="/consultas">Área de Consultas</a></li>
            <li><a class="sou-profissional" href="/profissional/homeprofs">Sou Profissional</a></li>
          </ul>


          <ul class="menu-list-direita">
            <li><a href="/login-pac" class="btn-entrar">Entrar</a></li>
          </ul>

        </nav>

        <nav class="mobile-menu">
          <section class="menu-logo">
            <a href="/">
              <img class="logo logo-desktop" src="/imagens/logo-bblt.png" alt="Logo InovaCare">
              <img class="logo logo-tablet" src="/imagens/logo-extenso.png" alt="Logo InovaCare">
              <img class="logo logo-mobile" src="/imagens/logo-borboleta.png" alt="Logo InovaCare">
            </a>
          </section>

          <ul class="menu-actions">
            <li><button class="hamburguer" onclick="toggleMenu()" aria-label="Menu"></button></li>
          </ul>

          <!-- Menu suspenso do hambúrguer -->
          <ul id="hamburger-menu" class="hamburger-menu-content">
            <li><a href="/login-pac" class="btn-entrar-mobile">Entrar</a></li>
            <li class="dropdown">
              <a href="#">Sobre</a>
              <ul class="dropdown-content">
                <li><a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">Quem somos</a></li>
                <li><a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">Contato</a></li>
                <li><a href="https://fiebedu.sharepoint.com/sites/saudedomiciliar">FAQ</a></li>
              </ul>
            </li>
            <li><a href="/especialidades">Agendamento</a></li>
            <li><a href="/consultas">Área de Consultas</a></li>
            <li><a href="/profissional/homeprofs">Sou Profissional</a></li>
          </ul>
        </nav>

        <script>
          function toggleMenu() {
            const menu = document.getElementById("hamburger-menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
          }
        </script>

        <!--barra de navegação - fim ^^^ -->
    <% } %>

    <main class="perfil-profissional">
        <section class="voltar">
            <a href="/cg">
                <img class="botao-voltar" src="/imagens/seta-esquerda.png" alt="Voltar">
            </a>
        </section>

        <section class="ttl-perfil-profissional">
            <h3>Perfil do Profissional</h3>
        </section>

        <section class="bg-perfil-profissional">
            <section class="top-profissional">
                <section class="esq-profissional">
                    <% if (profissional.foto_usuario) { %>
                        <% if (profissional.foto_usuario.startsWith('data:')) { %>
                            <img src="<%= profissional.foto_usuario %>" alt="Foto do <%= profissional.nome_usuario %>">
                        <% } else { %>
                            <img src="/<%= profissional.foto_usuario %>" alt="Foto do <%= profissional.nome_usuario %>">
                        <% } %>
                    <% } else { %>
                        <img src="/imagens/perfil-default.svg" alt="Foto do <%= profissional.nome_usuario %>">
                    <% } %>
                    <section class="nome-profissional"><%= profissional.nome_usuario %></section>
                    <section class="crm-profissional"><%= profissional.tipo_registro %>-<%= profissional.num_registro_especialista %></section>
                    <section class="avaliacao-geral" style="text-align: center; margin-top: 10px;">
                        <% const media = parseFloat(mediaAvaliacoes.media); %>
                        <% for (let i = 1; i <= 5; i++) { %>
                            <% if (i <= Math.floor(media)) { %>
                                <i class="bi bi-star-fill" style="color: #ffc107;"></i>
                            <% } else if (i - 0.5 <= media) { %>
                                <i class="bi bi-star-half" style="color: #ffc107;"></i>
                            <% } else { %>
                                <i class="bi bi-star" style="color: #ffc107;"></i>
                            <% } %>
                        <% } %>
                        <br>
                        <section style="font-size: 14px; color: #666;"><%= mediaAvaliacoes.total %> avaliações</section>
                    </section>
                </section>
                <section class="dir-profissional">
                    <h3 class="ttl-secao">Formação e Especialização</h3>
                    <section class="descricao-formacao">
                        <% if (infoProfissional.formacao_especialista) { %>
                            <p><%= infoProfissional.formacao_especialista %></p>
                        <% } else { %>
                            <p>Informações de formação não disponíveis.</p>
                        <% } %>
                        
                        <% if (profissional.nome_especialidade) { %>
                            <p><strong>Especialidade:</strong> <%= profissional.nome_especialidade %></p>
                        <% } %>
                        
                        <% if (infoProfissional.regioes_atendimento) { %>
                            <p><strong>Regiões de Atendimento:</strong> <%= infoProfissional.regioes_atendimento %></p>
                        <% } %>
                        
                        <% if (infoProfissional.linkddin_especialista) { %>
                            <p><strong>LinkedIn:</strong> <a href="<%= infoProfissional.linkddin_especialista %>" target="_blank">Ver perfil profissional</a></p>
                        <% } %>
                    </section>
                </section>
            </section>
        </section>

        <section class="comentarios-container">
            <h3 class="ttl-secao">Avaliações e Comentários</h3>
        
            <!-- Botão de avaliar -->
            <% if (usuarioLogado && usuarioLogado.tipo === 1) { %>
                <button class="btn-avaliar" id="btnAvaliar">Avaliar</button>
            <% } else if (!usuarioLogado) { %>
                <p style="text-align: center; color: #666; margin: 20px 0;">
                    <a href="/login-pac?redirect=<%= encodeURIComponent('/perfildoprof/' + profissional.id_usuario) %>" style="color: #007bff; text-decoration: none;">Faça login</a> para avaliar este profissional
                </p>
            <% } %>
        
            <!-- Formulário de avaliação -->
            <form class="form-comentario" id="formComentario" style="display: none;">
                <h3 class="ttl-secao">Deixe sua Avaliação</h3>
        
                <section class="campo-form">
                    <label for="avaliacao">Sua avaliação:</label>
                    <section class="avaliacao-form" id="avaliacaoEstrelas">
                        <i class="bi bi-star estrela-avaliacao" data-value="1"></i>
                        <i class="bi bi-star estrela-avaliacao" data-value="2"></i>
                        <i class="bi bi-star estrela-avaliacao" data-value="3"></i>
                        <i class="bi bi-star estrela-avaliacao" data-value="4"></i>
                        <i class="bi bi-star estrela-avaliacao" data-value="5"></i>
                    </section>
                    <input type="hidden" id="notaAvaliacao" name="nota" value="0">
                </section>
        
                <section class="campo-form" id="comentarioSection" style="display: none;">
                    <label for="comentario">Seu comentário:</label>
                    <textarea id="comentario" name="comentario"
                        placeholder="Compartilhe sua experiência com este profissional..."></textarea>
                </section>
        
                <button type="submit" class="btn-enviar-comentario">Enviar Avaliação</button>
            </form>
        
            <!-- Exibição das avaliações -->
            <section id="avaliacoesExibidas">
                <% if (avaliacoes && avaliacoes.length > 0) { %>
                    <% avaliacoes.forEach(avaliacao => { %>
                        <section class="comentario" data-avaliacao-id="<%= avaliacao.id_avaliacao %>">
                            <section class="cabecalho-comentario">
                                <section class="autor-comentario"><%= avaliacao.nome_paciente %></section>
                                <section class="data-comentario"><%= new Date(avaliacao.data_avaliacao).toLocaleDateString('pt-BR') %></section>
                            </section>
                            <section class="avaliacao-comentario">
                                <section class="estrelas">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <% if (i <= avaliacao.nota) { %>
                                            <i class="bi bi-star-fill"></i>
                                        <% } else { %>
                                            <i class="bi bi-star"></i>
                                        <% } %>
                                    <% } %>
                                </section>
                                <% if (usuarioLogado && usuarioLogado.id === avaliacao.id_usuario) { %>
                                    <i class="bi bi-pencil icone-editar-comentario" onclick="editarAvaliacao('<%= avaliacao.id_avaliacao %>', <%= avaliacao.nota %>, '<%= avaliacao.comentario %>')"></i>
                                <% } %>
                            </section>
                            <% if (avaliacao.comentario) { %>
                                <section class="texto-comentario">
                                    <%= avaliacao.comentario %>
                                </section>
                            <% } %>
                        </section>
                    <% }); %>
                <% } else { %>
                    <p>Ainda não há avaliações para este profissional.</p>
                <% } %>
            </section>


        </section>

    </main>

    <footer class="footer">
        <section class="footer-logo">
            <img class="footer-logo-desktop" src="/imagens/logo-bblt.png" alt="Logo da Empresa">
            <img class="footer-logo-mobile" src="/imagens/logo-extenso.png" alt="Logo da Empresa">
            <p class="footer-comentario">Oferecemos atendimento médico e terapêutico através das modalidades do
                atendimento online e domiciliar. Nosso objetivo é promover o acesso aos mais sectionersos serviços de
                saúde.
            </p>
        </section>

        <section class="footer-links">
            <h3 class="ttl-links">Explorar</h3>
            <ul class="links">
                <li><a href="#">Quem somos</a></li>
                <li><a href="#">FAQ</a></li>
                <li><a href="/singup">Especialidades</a></li>
                <li><a href="/singup">Consultas</a></li>
            </ul>
        </section>

        <section class="footer-contato">
            <h3 class="ttl-contato">Contato</h3>
            <p class="nmr-contato">(11) 4002-8922</p>
        </section>
    </footer>



    <script src="/js/perfildoprof.js"></script>
    <script>
        // Funcionalidade do formulário de avaliação
        const btnAvaliar = document.getElementById('btnAvaliar');
        if (btnAvaliar) {
            btnAvaliar.addEventListener('click', function() {
                const form = document.getElementById('formComentario');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Funcionalidade das estrelas
        const estrelas = document.querySelectorAll('.estrela-avaliacao');
        const notaInput = document.getElementById('notaAvaliacao');
        const comentarioSection = document.getElementById('comentarioSection');

        estrelas.forEach(estrela => {
            estrela.addEventListener('click', function() {
                const valor = parseInt(this.dataset.value);
                notaInput.value = valor;
                
                // Atualizar visual das estrelas
                estrelas.forEach((e, index) => {
                    if (index < valor) {
                        e.classList.remove('bi-star');
                        e.classList.add('bi-star-fill');
                    } else {
                        e.classList.remove('bi-star-fill');
                        e.classList.add('bi-star');
                    }
                });
                
                // Mostrar campo de comentário
                comentarioSection.style.display = 'block';
            });
        });

        // Envio do formulário
        document.getElementById('formComentario').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nota = document.getElementById('notaAvaliacao').value;
            const comentario = document.getElementById('comentario').value;
            
            if (nota === '0') {
                alert('Por favor, selecione uma nota.');
                return;
            }
            
            try {
                const response = await fetch('/avaliar-profissional', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idEspecialista: <%= profissional.id_especialista %>,
                        nota: parseInt(nota),
                        comentario: comentario
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Avaliação enviada com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao enviar avaliação');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar avaliação');
            }
        });

        // Função para editar avaliação
        function editarAvaliacao(idAvaliacao, notaAtual, comentarioAtual) {
            const comentarioElement = document.querySelector(`[data-avaliacao-id="${idAvaliacao}"]`);
            const estrelasElement = comentarioElement.querySelector('.estrelas');
            const textoElement = comentarioElement.querySelector('.texto-comentario');
            
            // Criar formulário de edição
            const formEdicao = document.createElement('section');
            formEdicao.className = 'form-edicao-avaliacao';
            formEdicao.innerHTML = `
                <section class="campo-form">
                    <label>Nova avaliação:</label>
                    <section class="avaliacao-form-edicao">
                        ${[1,2,3,4,5].map(i => `<i class="bi bi-star estrela-edicao" data-value="${i}" onclick="selecionarEstrela(${i}, '${idAvaliacao}')"></i>`).join('')}
                    </section>
                    <input type="hidden" id="notaEdicao-${idAvaliacao}" value="${notaAtual}">
                </section>
                <section class="campo-form">
                    <label>Novo comentário:</label>
                    <textarea id="comentarioEdicao-${idAvaliacao}" placeholder="Seu comentário...">${comentarioAtual || ''}</textarea>
                </section>
                <button type="button" onclick="salvarEdicao('${idAvaliacao}')">Salvar</button>
                <button type="button" onclick="cancelarEdicao('${idAvaliacao}')">Cancelar</button>
            `;
            
            // Substituir conteúdo
            comentarioElement.appendChild(formEdicao);
            estrelasElement.style.display = 'none';
            if (textoElement) textoElement.style.display = 'none';
            
            // Definir estrelas iniciais
            atualizarEstrelasEdicao(notaAtual, idAvaliacao);
        }

        function selecionarEstrela(valor, idAvaliacao) {
            document.getElementById(`notaEdicao-${idAvaliacao}`).value = valor;
            atualizarEstrelasEdicao(valor, idAvaliacao);
        }

        function atualizarEstrelasEdicao(nota, idAvaliacao) {
            const estrelas = document.querySelectorAll(`[data-avaliacao-id="${idAvaliacao}"] .estrela-edicao`);
            estrelas.forEach((estrela, index) => {
                if (index < nota) {
                    estrela.classList.remove('bi-star');
                    estrela.classList.add('bi-star-fill');
                } else {
                    estrela.classList.remove('bi-star-fill');
                    estrela.classList.add('bi-star');
                }
            });
        }

        async function salvarEdicao(idAvaliacao) {
            const nota = document.getElementById(`notaEdicao-${idAvaliacao}`).value;
            const comentario = document.getElementById(`comentarioEdicao-${idAvaliacao}`).value;
            
            try {
                const response = await fetch('/atualizar-avaliacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idAvaliacao: idAvaliacao,
                        nota: parseInt(nota),
                        comentario: comentario
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Avaliação atualizada com sucesso!');
                    location.reload();
                } else {
                    alert(result.message || 'Erro ao atualizar avaliação');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar avaliação');
            }
        }

        function cancelarEdicao(idAvaliacao) {
            const comentarioElement = document.querySelector(`[data-avaliacao-id="${idAvaliacao}"]`);
            const formEdicao = comentarioElement.querySelector('.form-edicao-avaliacao');
            const estrelasElement = comentarioElement.querySelector('.estrelas');
            const textoElement = comentarioElement.querySelector('.texto-comentario');
            
            formEdicao.remove();
            estrelasElement.style.display = 'flex';
            if (textoElement) textoElement.style.display = 'block';
        }
    </script>
</body>

</html>
